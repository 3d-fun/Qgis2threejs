<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>${title}</title>
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
body { margin: 0; overflow: hidden; }
</style>
</head>
<body>
<div id="webgl"></div>
<script src="./threejs/three.min.js"></script>
${controls}
<script src="./Qgis2threejs.js"></script>
<script>
${options}
</script>
${scripts}
<script>
  var width  = window.innerWidth;
  var height = window.innerHeight;

  var renderer = new THREE.WebGLRenderer();
  renderer.setSize(width, height);
  renderer.setClearColor(0xccccff, 1);

  var scene = new THREE.Scene();

  // light
  scene.add(new THREE.AmbientLight(0x999999));
  var light = new THREE.DirectionalLight(0xffffff, 0.4);
  light.position.set(0, -0.3, 1);
  scene.add(light);

  // camera and controls
  var camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
  camera.position.set(0, -100, 100);

  var controls = createControls(camera, renderer.domElement);
  controls.addEventListener('click', canvas_clicked);
  addDefaultKeyEventListener();

  var projector = new THREE.Projector();

  // build models
  buildModels(scene);

  document.getElementById('webgl').appendChild(renderer.domElement);
  render();

  function render() {
    controls.update();
    requestAnimationFrame(render);
    renderer.render(scene, camera);
  }

  function object_clicked(obj) {
    var object = obj.object;
    var pt = getMapCoordinates(obj.point.x, obj.point.y, obj.point.z);
    var r = [];
    r.push("Clicked coordinates (object surface)");
    r.push(" X: " + pt.x.toFixed(2));
    r.push(" Y: " + pt.y.toFixed(2));
    r.push(" Z: " + pt.z.toFixed(2));
    if (object.userData !== undefined) {
      var layer = lyr[object.userData[0]];
      r.push("");
      r.push("Layer: " + layer.name);

      if (layer.type != "dem") {
        var f = layer.f[object.userData[1]];
        if (f.a !== undefined) {
          for (var i = 0, l = f.a.length; i < l; i++) {
            r.push(layer.a[i] + ": " + f.a[i]);
          }
        }
      }
    }
    alert(r.join("\n"));
  }

  function canvas_clicked(e) {
    if (object_clicked === undefined) return;
    var canvasOffset = offset(renderer.domElement);
    var mx = e.clientX - canvasOffset.left;
    var my = e.clientY - canvasOffset.top;
    var x = (mx / renderer.domElement.width) * 2 - 1;
    var y = -(my / renderer.domElement.height) * 2 + 1;
    var vector = new THREE.Vector3(x, y, 1);
    projector.unprojectVector(vector, camera);
    var ray = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize())
    var obj = ray.intersectObjects(queryableObjs);
    if(obj.length > 0) object_clicked(obj[0]);
  }

  function offset(elm) {
    var top = left = 0;
    do {
      top += elm.offsetTop || 0; left += elm.offsetLeft || 0; elm = elm.offsetParent;
    } while(elm);
    return {top: top, left: left};
  }
</script>
</body>
</html>
